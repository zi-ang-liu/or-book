---
title: 新聞売り子問題
format:
  html:
    code-fold: true
jupyter: python3
---

新聞売り子問題（Newsvendor Problem）は、古典的な確率的在庫モデルの一つである。新聞は次の日には売れなくなるため、新聞売り子問題は最も単純な perishable 在庫モデルとして知られている。

![Jacob Epstein, Buying a Newspaper. The Spirit of the Ghetto, 1902, public domain, Wikimedia Commons](fig/Buying_a_newspaper.jpg)

新聞売り子が新聞を仕入れ、販売する問題を考える。新聞 1 部の欠品費用を $p$、保管費用を $h$ とする。新聞売子問題において、$p$ を**在庫不足費用**（underage cost）、$h$ を**在庫超過費用**（overage cost）とも呼ぶ。$p \gt 0$、$h \gt 0$ とし、初期在庫は 0 とする。

新聞の需要 $D$ を確率変数とするとき、新聞売り子はどれだけの新聞を発注すればよいかという問題である。

## 記号

| 記号 | 意味 |
|:---|:---|
| $h$ | 1 個当たりの在庫超過費用 |
| $p$ | 1 個当たりの在庫不足費用 |
| $D$ | 需要（確率変数） |
| $d$ | 需要の観測値 |
| $f_D(d)$ | 需要 $D$ の確率密度関数 |
| $F_D(d)$ | 需要 $D$ の累積分布関数 |
| $S$ | 発注量 |
| $g(S, d)$ | 発注量 $S$、需要の観測値 $d$ に対するコスト |
| $g(S)$ | $g(S, d)$ の期待値、$g(S) = \mathbb{E}[g(S, D)]$ |

## 定式化

新聞売り子が $S$ 部の新聞を仕入れ、需要 $D$ が $d$ であったとする。このとき、新聞売り子のコスト $g(S, d)$ は以下のように表される。

$$
g(S, d) = h (S - d)^+ + p (d - S)^+
$$  {#eq-newsvendor-cost}

:::{#exm-newsvendor-cost}
発注量 $S = 100$、需要 $D$ の観測値 $d = 120$、在庫超過費用が $h = 10$、在庫不足費用が $p = 5$ のとき、コスト $g(S, d)$ は以下のように求められる。

$$
g(100, 120) = 10 (100 - 120)^+ + 5 (120 - 100)^+ = 100
$$
:::

観測値 $d$ が分かれば、コスト $g(S, d)$ を計算できる。しかし、需要 $D$ が確率変数であることを思い出そう。ここからは、需要 $D$ が連続型確率変数であると仮定する。

需要 $D$ の確率密度関数を $f_D(d)$、累積分布関数を $F_D(d)$ とする。発注量を $S$ としたとき、需要 $D \leq S$ である確率は、累積分布関数 $F_D(S)$ で与えられる。

$$
P(D \leq S) = F_D(S) = \int_{0}^{S} f_D(d) dd
$$ {#eq-newsvendor-S}

:::{#exm-newsvendor-distribution}
需要 $D$ が一様分布 $U(100,300)$ に従うとき、確率密度関数 $f_D(250)$ と累積分布関数 $F_D(250)$ は以下のように表される。

```{python}
# | layout-ncol: 2
# | fig-cap:
# |   - "確率密度関数 $f_D(d)$"
# |   - "累積分布関数 $F_D(d)$"
import matplotlib.pyplot as plt
import numpy as np
from scipy.stats import uniform

# 一様分布のパラメータ
a = 100
b = 300
# 需要の範囲
d = np.linspace(a - 50, b + 50, 1000)
# plot pdf with shaded area
plt.figure(figsize=(4, 4))
plt.plot(d, uniform.pdf(d, a, b - a))
plt.fill_between(
    d,
    0,
    uniform.pdf(d, a, b - a),
    where=(d <= 250),
    color="skyblue",
    alpha=0.5,
    label="F(250)",
)
plt.xlabel(r"$D$")
plt.ylabel(r"$f_D(d)$")
plt.xlim(a - 50, b + 50)
plt.ylim(0, 0.006)
plt.show()

# plot cdf
plt.figure(figsize=(4, 4))
plt.plot(d, uniform.cdf(d, a, b - a))
plt.axvline(250, color="r", linestyle="--", label="d=250")
plt.xlabel(r"$D$")
plt.ylabel(r"$F_D(d)$")
plt.xlim(a - 50, b + 50)
plt.ylim(0, 1.1)
plt.show()
```

需要 $D \leq 250$ である確率は、累積分布関数 $F_D(250)$ で与えられる。

$$
P(D \leq 250) = F_D(250) = \int_{100}^{250} f_D(d) dd = 0.75
$$

需要 $D > 250$ である確率は $1 - F_D(250)$ で与えられる。

$$
P(D > 250) = 1 - F_D(250) = 1 - \int_{100}^{250} f_D(d) dd = 0.25
$$
:::

$D$ が確率変数であるため、コストも確率変数となる。新聞売り子問題の目的は、コストの期待値を最小化することである。

ここで、コストの期待値を $g(S) = \mathbb{E}[g(S, D)]$ とする。$g(S, D)$ は @eq-newsvendor-cost で与えられるため、コストの期待値 $g(S)$ は以下のように表される。

\begin{align}
g(S) &= \mathbb{E}[g(S, D)] \\
&= \mathbb{E}[h (S - D)^+ + p (D - S)^+] \\
&= \mathbb{E}[h (S - D)^+] + \mathbb{E}[p (D - S)^+] \\
&= h \mathbb{E}[(S - D)^+] + p \mathbb{E}[(D - S)^+] \\
\end{align}

この式により、コストの期待値 $g(S)$ は、$(S - D)^+$ の期待値かける在庫超過費用 $h$ と、$(D - S)^+$ の期待値かける在庫不足費用 $p$ の和であることが分かる。

:::{.callout-tip}
### 期待値の線形性（Linearity of Expectation）

$X$ と $Y$ を確率変数、$a$ と $b$ を定数とする。このとき、

$$
\mathbb{E}[X + Y] = \mathbb{E}[X] + \mathbb{E}[Y]
$$

$$
\mathbb{E}[aX + b] = a\mathbb{E}[X] + b
$$

が成り立つ。
:::

需要 $D$ が連続型確率変数であるため、$\mathbb{E}[(S - D)^+]$ と $\mathbb{E}[(D - S)^+]$ は以下のように表される。
\begin{align}
\mathbb{E}[(S - D)^+]
&= \int_{0}^{\infty} (S - d)^+ f_D(d) dd = \int_{0}^{S} (S - d) f_D(d) dd \\
\mathbb{E}[(D - S)^+]
&= \int_{0}^{\infty} (d - S)^+ f_D(d) dd = \int_{S}^{\infty} (d - S) f_D(d) dd
\end{align}

:::{.callout-tip}
### 連続型確率変数の期待値
$X$ を連続型確率変数、$f_X(x)$ を $X$ の確率密度関数とする。このとき、$X$ の期待値 $\mathbb{E}[X]$ は以下のように表される。

$$
\mathbb{E}[X] = \int_{-\infty}^{\infty} x f_X(x) dx
$$

$\mathbb{E}[g(X)]$ は以下のように表される。

$$
\mathbb{E}[g(X)] = \int_{-\infty}^{\infty} g(x) f_X(x) dx
$$
:::

したがって、コストの期待値 $g(S)$ は以下のように表される。

\begin{align}
g(S) &= \mathbb{E}[g(S, D)] \\
&= h \mathbb{E}[(S - D)^+] + p \mathbb{E}[(D - S)^+] \\
&= h \int_{0}^{S} (S - d) f_D(d) dd + p \int_{S}^{\infty} (d - S) f_D(d) dd
\end{align}

:::{#exm-newsvendor-expectation}

需要 $D$ が一様分布 $U(100,300)$ に従う新聞売り子問題を考える。在庫超過費用が $h = 10$、在庫不足費用が $p = 5$ のとき、発注量 $S = 150$ に対するコストの期待値 $g(150)$ は以下のように求められる。

$$
g(150) = 10 \int_{100}^{150} (150 - d) f_D(d) dd + 5 \int_{150}^{300} (d - 150) f_D(d) dd
$$
:::

## 最適化

以下の手順で、コストの期待値 $g(S)$ を最小化する発注量 $S^*$ を求める。

1. $g(S)$ の1階微分を求める。
2. $dg(S)/dS = 0$ を解く。
3. 2階微分を求め、$g(S)$ が凸関数であることを確認する。

@eq-newsvendor-S を用い、$g(S)$ の1階微分は以下のように求める。

\begin{align}
\frac{dg(S)}{dS} &= h \int_{0}^{S} f_D(d) dd - p \int_{S}^{\infty} f_D(d) dd \\
&= h F_D(S) - p (1 - F_D(S)) \\
\end{align}

よって、$dg(S)/dS = 0$ から、

\begin{align}
h F_D(S) - p (1 - F_D(S)) &= 0 \\
F_D(S) &= \frac{p}{h + p}
\end{align}

になる。2 階微分は

\begin{align}
\frac{d^2g(S)}{dS^2} &= h f_D(S) + p f_D(S) \\
&= (h + p) f_D(S) > 0
\end{align}

である。したがって、コスト関数 $g(S)$ は凸関数であり、1 階微分が 0 になる点は最小値を与える。

コスト関数 $g(S)$ を最小化するための最適発注量 $S^*$ は

$$
S^* = F_D^{-1}\left(\frac{p}{h + p}\right)
$$

となる。ここで、$F_D^{-1}$ は需要 $D$ の累積分布関数の逆関数である。

:::{.callout-tip}
### 逆関数（Inverse Function）
ある関数 $y = f(x)$ に対し、次の条件を満たす関数 $x = f^{-1}(y)$ を $f(x)$ の逆関数と呼ぶ。

$$
f(f^{-1}(y)) = y, \quad f^{-1}(f(x)) = x
$$
:::

:::{#thm-newsvendor}

新聞売り子問題における最適発注量 $S^*$ は、

$$
S^* = F_D^{-1}\left(\frac{p}{h + p}\right)
$$

で与えられる。
:::

## 臨界率

以上の議論から、最適発注量 $S^*$ は以下の式を満たす。

$$
F_D(S) = P(D \leq S) = \frac{p}{h + p}
$$

ここで、$F_D(S) = P(D \leq S)$ は需要 $D$ が発注量 $S$ 以下である確率を表す。言い換えると、欠品が発生しない確率を表す。この確率のことは**サービスレベル**（service level）と呼ぶ。@thm-newsvendor は、サービスレベルを $p/(h+p)$ に等しくする発注量 $S$ が最適であることを示している。

この $p/(h+p)$ は**臨界率**（critical ratio）と呼ばれる。

:::{#rem-newsvendor}
- 在庫不足費用 $p$ の増加に伴い、サービスレベル $p/(h+p)$ は増加し、最適発注量 $S^* = F_D^{-1}(p/(h+p))$ も増加する。
- 在庫超過費用 $h$ の増加に伴い、サービスレベル $p/(h+p)$ は減少し、最適発注量 $S^* = F_D^{-1}(p/(h+p))$ も減少する。
- 直感的に、在庫不足費用が増加すると、欠品を避けるために発注量が増加し、サービスレベルも上昇する。一方、在庫超過費用が増加すると、過剰在庫を避けるために発注量が減少し、サービスレベルも低下する。
:::


## 例題

:::{#exm-newsvendor}

需要 $D$ が正規分布 $N(100, 25)$ に従う新聞売り子問題を考える。在庫超過費用が $h = 10$、在庫不足費用が $p = 40$ のとき、最適発注量 $S^*$ を求める。

@thm-newsvendor より、$S^*$ は以下の式で与えられる。

$$
S^* = F_D^{-1}\left(\frac{p}{h + p}\right) = F_D^{-1}\left(\frac{40}{10 + 40}\right) = F_D^{-1}\left(0.8\right)
$$

言い換えると、$F_D(S^*) = 0.8$ を満たす $S^*$ を求めればよい。これを図で表すと、面積が 0.8 になるような $S^*$ を求めることに相当する。

```{python}
import matplotlib.pyplot as plt
import numpy as np
from scipy.stats import norm

# 正規分布のパラメータ
mu = 100
sigma = 5

# 需要の範囲
d = np.linspace(mu - 4 * sigma, mu + 4 * sigma, 1000)
S_star = norm.ppf(0.8, loc=mu, scale=sigma)

# plot the normal distribution
plt.plot(d, norm.pdf(d, mu, sigma))
plt.fill_between(
    d,
    0,
    norm.pdf(d, mu, sigma),
    where=(d <= S_star),
    color="skyblue",
    alpha=0.5,
    label="F(S*)",
)
plt.xlabel("Demand")
plt.ylabel("Probability Density")
plt.axvline(mu, color="r", linestyle="--", label="mu")
plt.axvline(S_star, color="g", linestyle="--", label="S*")
plt.ylim(0, 0.09)
plt.legend()
plt.show()
```

:::

下では、Excel、Python、標準正規分布表を用いて $S^*$ を求める方法を示す。

### Excel

Excel では、`NORM.INV(確率,平均,標準偏差)` 関数を用いて $F_D^{-1}(0.8)$ を求めることができる。

```excel
=NORM.INV(0.8, 100, 5)
```

### Python

Python では、SciPy ライブラリの `ppf()` 関数を用いて、逆関数を求めることができる。

```{python}
# | code-fold: false

from scipy.stats import norm

# 正規分布のパラメータ
mu = 100
sigma = 5

# 在庫超過費用と在庫不足費用
h = 10
p = 40

# 臨界率
critical_ratio = p / (h + p)

# 最適発注量
S_star = norm.ppf(critical_ratio, loc=mu, scale=sigma)
print(f"Optimal order quantity S*: {S_star:.2f}")
```

### 標準正規分布表

新聞売り子問題の最適発注量 $S^*$ は、以下の式を満たす。

$$
F_D(S^*) = \frac{p}{h + p}
$$

ここで、$D$ は正規分布 $N(\mu, \sigma^2)$ に従うため、

$$
F_D(S^*) = P(D \leq S^*) = \Phi\left(\frac{S^* - \mu}{\sigma}\right)
$$
である。したがって、$S^*$ は以下の式を満たす。

$$
\Phi\left(\frac{S^* - 100}{5}\right) = \frac{p}{h + p}
$$

:::{.callout-tip}
### 標準正規分布（Standard Normal Distribution）
平均 0、分散 1 の正規分布を**標準正規分布**（standard normal distribution）と呼ぶ。標準正規分布の確率密度関数を $\phi(z)$、累積分布関数を $\Phi(z)$ と表す。

ある正規分布 $N(\mu, \sigma^2)$ に従う確率変数 $X$ の累積分布関数 $F_X(x)$ は、標準正規分布の累積分布関数 $\Phi(z)$ を用いて以下のように表される。
$$
F_X(x) = P(X \leq x) = \Phi\left(\frac{x - \mu}{\sigma}\right)
$$

与えられた $z$ に対し、$\Phi(z)$ の値は**標準正規分布表**（standard normal table）を用いて調べることができる。
:::

[標準正規分布表](../appendices/standard_normal_table.qmd) を調べると、$\Phi(z) = 0.8$ のとき、$z$ は約 0.84 である。したがって、$S^*$ は以下の式を満たす。

$$
\frac{S^* - 100}{5} \approx 0.84
$$

これを解くと、$S^* \approx 104.2$ となる。

:::{.callout-note}
$D \sim N(\mu, \sigma^2)$ の新聞売り子問題において、在庫超過費用が $h$、在庫不足費用が $p$ のとき、最適発注量
$S^*$ は

$$
S^* = \sigma z + \mu
$$
で与えられる。ここで、$z$ は $\Phi(z) = p/(h+p)$ を満たす値である。
:::

## 再定式化

新聞 1 部の仕入れ価格を $c$、販売価格を $r$、残存価額を $v$、欠品費用を $p$、保管費用を $h$ とする。ここで、以下の条件を満たすとする。

- $r > c$. 販売価格は仕入れ価格より高い。
- $r > v$. 販売価格は残存価値より高い。

新聞売り子が $S$ 部の新聞を仕入れ、需要 $D$ が $d$ であったとする。このとき、新聞売り子の利益 $\pi(S, d)$ は以下のように表される。

### コスト関数

\begin{align}
\pi(S, d) & = r \min\{d, S\} - cS + v \max\{0, S - d\} \\
& \quad - h \max\{0, S - d\} - p \max\{0, d - S\}
\end{align}

第一項は販売利益、第二項は仕入れコスト、第三項は残存価値、第四項は保管コスト、第五項は欠品コストである。

以下は、$\max\{0, x\} = x^+$ を用いて書き換えた形である。整理すると、利益は以下のように表される。

$$
\pi(S, d) = r \min\{d, S\} - cS + (v - h) (S - d)^+ - p (d - S)^+
$$

第一項を以下のように書き換えることができる。

$$
r \min\{d, S\} = r d - r (d - S)^+
$$

:::{.callout-note}
- $d < S$ の場合、$r \min\{d, S\} = r d$ となる。
- $d >= S$ の場合、$r \min\{d, S\} = r d - r(d - S) = r S$ となる。
:::

したがって、利益は以下のように書き換えられる。

$$
\pi(S, d) = r d - cS + (v- h) (S - d)^+ - (p + r) (d - S)^+
$$

利益の最大化は、コストの最小化に帰着される。したがって、コスト関数 $g(S, d) = -\pi(S, d)$ は以下のように表される。

$$
g(S, d) = cS - rd + (h - v) (S - d)^+ + (p + r) (d - S)^+
$$

$D$ が確率変数であるため、コストの期待値 $g(S)$ は以下のように表される。

\begin{align}
g(S) &= \mathbb{E}[g(S, D)] \\
&= \int_{0}^{\infty} g(S, d) f_D(d) dd \\
&= cS - r\mathbb{E}[D] + (h - v) \mathbb{E}[(S - D)^+] + (p + r) \mathbb{E}[(D - S)^+] \\
&= c S - r \mu + (h - v)  \int_{0}^{\infty}(S - d)^+ f_D(d) dd + (p + r) \int_{0}^{\infty} (d - S)^+ f_D(d) dd \\
&= c S - r \mu + (h - v) \int_{0}^{S} (S - d) f_D(d) dd + (p + r) \int_{S}^{\infty} (d - S) f_D(d) dd
\end{align}

### 最適化

$g(S)$ の1階微分は以下のように求める。

\begin{align}
\frac{dg(S)}{dS} &= c + (h - v) F_D(S) - (p + r) (1 - F_D(S)) \\
\end{align}

よって、$dg(S)/dS = 0$ から、

\begin{align}
c + (h - v) F_D(S) - (p + r) (1 - F_D(S)) &= 0 \\
F_D(S) &= \frac{p + r - c}{h + p + r - v}
\end{align}

になる。2 階微分は

\begin{align}
\frac{d^2g(S)}{dS^2} &= (h - v) f_D(S) + (p + r) f_D(S) \\
&= (h - v + p + r) f_D(S) 
\end{align}

である。したがって、コスト関数 $g(S)$ は凸関数であり、1 階微分が 0 になる点は最小値を与える。

コスト関数 $g(S)$ を最小化するための最適発注量 $S^*$ は

$$
S^* = F_D^{-1}\left(\frac{p + r - c}{h + p + r - v}\right)
$$
となる。ここで、$F_D^{-1}$ は需要 $D$ の累積分布関数の逆関数である。

新聞売り子問題において、より一般的に、在庫超過費用（overage cost）と 在庫不足費用（underage cost）を考慮する。

$$
C_o = h + c - v, \quad C_u = p + r - c
$$

### 臨界率

在庫超過費用 $C_o$ は、在庫が余ったときのコストである。1 部の在庫超過に対し、保管コストと仕入れコストが発生するが、残存価額が得られないため、$C_o = h + c - v$ となる。

在庫不足費用 $C_u$ は、在庫が不足したときのコストである。1 部の在庫不足に対し、欠品コスト $p$ と失われた販売機会の利益 $r - c$ が発生するため、$C_u = p + r - c$ となる。

従って、

\begin{align*}
S^* &= F_D^{-1}\left(\frac{p + r - c}{h + p + r - v}\right)\\
&= F_D^{-1}\left(\frac{C_u}{C_o + C_u}\right)
\end{align*}

が得られる。

## 初期在庫を考慮した新聞売り子問題

新聞売り子の初期在庫を $I$ とする。$I \leq S^*$の場合、最適発注量は $S^* - I$ となる。すなわち、在庫量を $S^*$ にすればよい。

また、$g(S)$ は凸関数であるため、$I > S^*$ の場合、何も発注しないことが最適である。

したがって、最適発注量は

$$
Q =
\begin{cases}
S^* - I, & \text{if } I \le S^*, \\[6pt]
0, & \text{if } I > S^* .
\end{cases}
$$

となる。

このような発注方式を **Base Stock Policy** (BSP) と呼ぶ。BSP は、各期間の在庫量を観測し、在庫量が $S^*$ に引き上げられるように発注する方式である。新聞売り子問題において、BSP は最適な方策であると知られている。

<!-- [Arrow et al. (1951)](https://doi.org/10.2307/1906813)
[Chen et al. (2016)](https://doi.org/10.1111/deci.12215) は新聞売り子問題の最新研究をレビューしている。最近では、データ駆動新聞売り子問題（Data-Driven Newsvendor Problem）に関する研究が行われている。 -->

## 発注費用を考慮した新聞売り子問題

@Scarf1959-xl の論文では、$(s, S)$ 方策が発注費用を考慮した複数期間の新聞売り子問題において最適であることを示している。

<!-- 1. 発注量 $S = 100$、需要 $D$ の観測値 $d = 120$、在庫超過費用が $h = 10$、在庫不足費用が $p = 40$ のとき、コスト $g(S, d)$ を求めよ。
2. 需要 $D$ が正規分布 $N(150, 36)$ に従う新聞売り子問題を考える。在庫超過費用が $h = 5$、在庫不足費用が $p = 20$ のとき、最適発注量 $S^*$ を求めよ。 -->

## 練習問題

:::{#exr-newsvendor-basic}
ある弁当屋では、1 個 500 円で弁当を仕入れ、1 個 800 円で販売している。売れ残った弁当を廃棄する場合、1 個当たり 10 円の廃棄費用がかかる。
弁当の需要 $D$ は、正規分布 $N(50, 8^2)$ に従うとする。このとき、最適な弁当の発注量を求めよ。
:::

:::{#sol-newsvendor-basic}
弁当 1 個当たりの在庫超過費用 $h$、在庫不足費用 $p$ は以下のように求められる。
$$
h = 10 + 500 = 510, \quad p = 800 - 500 = 300
$$

したがって、$S^*$ は以下のように求められる。

$$
S^* = F_D^{-1}\left(\frac{p}{h + p}\right) = F_D^{-1}\left(\frac{300}{510 + 300}\right) \approx F_D^{-1}\left(0.37\right)
$$

標準正規分布表を調べると、$\Phi(z) = 0.37$ のとき、$z$ は約 -0.33 である。したがって、$S^*$ は

$$
S^* = -0.33 \times \sigma + \mu = -0.33 \times 8 + 50 \approx 47.36
$$

となる。

```{python}
from scipy.stats import norm

# 正規分布のパラメータ
mu = 50
sigma = 8
# 在庫超過費用と在庫不足費用
h = 510
p = 300
# 臨界率
critical_ratio = p / (h + p)
# 最適発注量
S_star = norm.ppf(critical_ratio, loc=mu, scale=sigma)
print(f"Optimal order quantity S*: {S_star:.4f}")
```

:::
