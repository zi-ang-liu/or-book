---
title: 階層分析法
format:
  html:
    code-fold: true
jupyter: python3
---

:::{.callout-tip}
## 予備知識
- 線形代数
:::

AHPは，複数の代替案の中から一つの代替案を選択するための手法である．

## 代替案

代替案の集合 $X = \{x_1, x_2, \ldots, x_n\}$ とする．代替案の重要度を 

$$
\mathbf{w} = (w_1, w_2, \ldots, w_n)^T
$$

で表す．ここで，$w_i$ は代替案 $x_i$ の重要度を表し，$\sum_{i=1}^n w_i = 1$ を満たす．AHPでは，$\mathbf{w}$ を計算できるものとする．計算する方法は後述する．

$w_i$ が大きいほど，代替案 $x_i$ が望ましいとする．$w_i > w_j$ ならば，代替案 $x_i$ は代替案 $x_j$ より望ましい．このとき，$x_i \succ x_j$ と表す．

:::{#exm-weights}
旅行先の代替案 
$$
X = \{\text{北海道}, \text{沖縄}, \text{九州}\}
$$ 

とし，各代替案の重要度を $\mathbf{w} = (0.3, 0.5, 0.2)^T$ とするとき，
$$
\text{沖縄} \succ \text{北海道} \succ \text{九州}
$$
である．
:::

このように，それぞれの代替案の重要度が与えられるならば，望ましい代替案の選択は容易である．しかし，実際には，代替案の重要度を直接決定することは難しい．

## 記号

| 記号 | 意味               |
| ---- | ------------------ |
| $\mathbf{A}$ | 一対比較行列       |
| $X$ | 代替案の集合       |
| $x_i$ | 代替案 $i$         |
| $a_{ij}$ | 一対比較値       |
| $\mathbf{w}$ | 重要度ベクトル |


## 一対比較 

すべての代替案を並べて比較することは難しい．そこで，AHPでは，2つの代替案を比較する**一対比較** (pairwise comparison)を用いる．その理由として，$\{x_1, x_2, \ldots, x_n\}$ の中から最も望ましい代替案を選ぶことは難しいが，2つの代替案 $x_i$ と $x_j$ のどちらが望ましいかを決定することは比較的容易であることが挙げられる．

AHPでは，$x_i$ は $x_j$ よりどれくらい望ましいかを**一対比較値**で表す．正式には，一対比較値 $a_{ij}$ は $x_i$ が $x_j$ より $a_{ij}$ 倍望ましいことを表す．

例えば，$a_{ij} = 3$ ならば，$x_i$ は $x_j$ より3倍望ましいことを表す．@exm-weights で，$a_{12} = 3$ ならば，$x_1$ （北海道）は $x_2$ （沖縄）より3倍望ましいことを表す．

Saatyは，一対比較値を以下の尺度で表すことを提案した．

**Table: The fundamental scale of absolute numbers (Saaty, 2008)**

| Importance | Definition        | Explanation                                                                      |
| ---------- | ----------------- | -------------------------------------------------------------------------------- |
| 1          | Equal             | Two activities contribute equally to the objective                               |
| 2          | Weak or slight    | -                                                                                |
| 3          | Moderate          | Experience and judgment slightly favor one activity over another                 |
| 4          | Moderate plus     | -                                                                                |
| 5          | Strong            | Experience and judgment strongly favor one activity over another                 |
| 6          | Strong plus       | -                                                                                |
| 7          | Very strong       | An activity is favored very strongly over another activity                       |
| 8          | Very, very strong | -                                                                                |
| 9          | Extreme           | The evidence favoring one activity over another is of the highest possible order |

すべての代替案の組み合わせについて一対比較を行い，その結果を**一対比較行列** (pairwise comparison matrix)にまとめる．一対比較行列は $\mathbf{A} = [a_{ij}]_{n \times n}$ と定義され，以下のように表される。

$$
\mathbf{A} = \begin{bmatrix}
a_{11} & a_{12} & \cdots & a_{1n} \\
a_{21} & a_{22} & \cdots & a_{2n} \\
\vdots & \vdots & \ddots & \vdots \\
a_{n1} & a_{n2} & \cdots & a_{nn} \\
\end{bmatrix}
$$

理論的には，

$$
a_{ij} \approx \frac{w_i}{w_j} \quad \forall i, j
$$

が想定されている．

:::{.callout-tip}
意思決定者が一対比較を行うとき，$\mathbf{w} = (w_1, w_2, \ldots, w_n)^T$ が知らないが，合理的な意思決定者ならば，$a_{ij} = w_i/w_j$ を満たすと考えられる．
:::

意思決定者が完全に合理的であるならば，$a_{ij} = w_i/w_j$ を満たす．
このとき，一対比較行列 $\mathbf{A}$ は以下のようになる．

$$
\mathbf{A} = \begin{bmatrix}
w_1/w_1 & w_1/w_2 & \cdots & w_1/w_n \\
w_2/w_1 & w_2/w_2 & \cdots & w_2/w_n \\
\vdots & \vdots & \ddots & \vdots \\
w_n/w_1 & w_n/w_2 & \cdots & w_n/w_n \\
\end{bmatrix}
$$

このとき，$\mathbf{A}$ は完全に整合性 (consistency) を持つと言う．$\mathbf{A}$ は，以下の性質が成り立つ．

- $a_{ii} = 1, \forall i$
- $a_{ij} = 1/a_{ji}, \forall i, j$

例えば，$a_{12} = 3$ ならば，$x_1$ は $x_2$ より3倍望ましい，かつ，$x_2$ は $x_1$ より $1/3$ 倍望ましいことが分かる．

:::{.callout-tip}
$a_{ij} = w_i/w_j$ とするとき，この2つの性質は，以下のように導かれる．

$$
a_{ii} = \frac{w_i}{w_i} = 1
$$

$$
a_{ij} = \frac{w_i}{w_j} = \frac{1}{\frac{w_j}{w_i}} = \frac{1}{a_{ji}}
$$
:::

:::{#exm-pairwise}
旅行先の代替案 $X = \{\text{北海道}, \text{沖縄}, \text{九州}\}$ とし，以下の一対比較を行ったとする．

- $x_1$ （北海道）は $x_2$ （沖縄）より3倍望ましい
- $x_1$ （北海道）は $x_3$ （九州）より6倍望ましい
- $x_2$ （沖縄）は $x_3$ （九州）より2倍望ましい

このとき，一対比較行列 $\mathbf{A}$ は以下のようになる．

$$
\mathbf{A} = \begin{bmatrix}
1 & 3 & 6 \\
1/3 & 1 & 2 \\
1/6 & 1/2 & 1 \\
\end{bmatrix}
$$
:::

## 重要度ベクトル

一対比較行列 $\mathbf{A}$ が与えられたとき，重要度ベクトル $\mathbf{w}$ を計算する方法を説明する．

まず，意思決定者が完全に合理的であるならば，$a_{ij} = w_i/w_j$ を満たすため，$\mathbf{A}$ は

$$
\mathbf{A} = \begin{bmatrix}
w_1/w_1 & w_1/w_2 & \cdots & w_1/w_n \\
w_2/w_1 & w_2/w_2 & \cdots & w_2/w_n \\
\vdots & \vdots & \ddots & \vdots \\
w_n/w_1 & w_n/w_2 & \cdots & w_n/w_n \\
\end{bmatrix}
$$

であるから，$\mathbf{A}$ の各列は比例している．このとき，重要度ベクトル $\mathbf{w}$ は，$\mathbf{A}$ の任意の列を正規化することで求められる．

@exm-pairwise の一対比較行列 $\mathbf{A}$ を考える．

$$
\mathbf{A} = \begin{bmatrix}
1 & 3 & 6 \\
1/3 & 1 & 2 \\
1/6 & 1/2 & 1 \\
\end{bmatrix}
$$

このとき，$\mathbf{A}$ の第3列を正規化すると，重要度ベクトル $\mathbf{w}$ は以下のようになる．
$$
w_1 = \frac{6}{6 + 2 + 1} = \frac{6}{9} \approx 0.67
$$
$$
w_2 = \frac{2}{6 + 2 + 1} = \frac{2}{9} \approx 0.22
$$
$$
w_3 = \frac{1}{6 + 2 + 1} = \frac{1}{9} \approx 0.11
$$

## 階層

AHPでは，複数の**評価基準**（criterion）を用いて代替案を評価することができる．例えば，旅行先の代替案を評価するとき，費用，距離，環境などの評価基準を用いることができる．

:::{.callout-tip}
意思決定者が直接代替案を一対比較することは難しいが，評価基準を用いて代替案を評価することは比較的容易であると考えられる．
:::

AHPでは，評価基準を用いて代替案を評価するために，**階層** (hierarchy) を用いる．階層は，以下の要素から構成される．

- 目的 (goal)
- 評価基準 (criteria)
- 代替案 (alternatives)

正式に，評価基準の集合を $C = \{c_1, c_2, \ldots, c_m\}$ とする．

:::{#exm-hierarchy}
旅行先の代替案を $X = \{\text{北海道}, \text{沖縄}, \text{九州}\}$ とし，評価基準 $C = \{\text{費用}, \text{食事}, \text{環境}\}$ とする．このとき，以下のような階層を考える．

```{mermaid}
graph TD
    A[旅行先の選択]
    subgraph 評価基準
        B[費用]
        C[食事]
        D[環境]
    end
    subgraph 選択肢
        E[北海道]
        F[沖縄]
        G[九州]
    end
    A --> B
    A --> C
    A --> D
    B --> E
    B --> F
    B --> G
    C --> E
    C --> F
    C --> G
    D --> E
    D --> F
    D --> G
    style 評価基準 fill:#ccc
    style 選択肢 fill:#ccc
```
:::

このような階層構造を用いることで，評価基準に基づいて代替案を評価することができる．各評価基準 $c_k$ を用いて，代替案の一対比較行列 $\mathbf{A}^{(k)}$ を構築する．



## 重要度ベクトルと整合性

しかし，人間の評価は必ずしも合理的でないため，一般には $a_{ij} = w_i/w_j$ を満たさない．このとき，他の方法で一対比較行列 $\mathbf{A}$ から重要度ベクトル $\mathbf{w}$ を計算する必要がある．計算する方法として，主に**幾何平均法** (geometric mean method) と**固有ベクトル法** (eigenvector method) の2つがある．

:::{.callout-tip}
幾何平均法と固有ベクトル法のどちらが優れているかについては議論がある．AHPの創始者であるSaatyは固有ベクトル法が優れていると主張しているが，幾何平均法が優れているとする出張する研究もある．

他にもnormalized columns methodという方法もあるが，理論的根拠がないと言われている．
:::

### 幾何平均法

@Crawford1985-gb は，幾何平均法を提案した．幾何平均法では，重要度ベクトル $\mathbf{w}$ の各要素 $w_k$ を以下のように計算する．

$$
w_k = \frac{\left(\prod_{j=1}^n a_{kj}\right)^{1/n}}{\sum_{i=1}^n \left(\prod_{j=1}^n a_{ij}\right)^{1/n}} \quad \forall k
$$

:::{.callout-tip}
$\mathbf{A}$ の各行の幾何平均を計算し，正規化することで，重要度ベクトル $\mathbf{w}$ を求めている．
:::

@exm-pairwise の一対比較行列 $\mathbf{A}$ を考える．

$$
\mathbf{A} = \begin{bmatrix}
1 & 3 & 6 \\
1/3 & 1 & 2 \\
1/6 & 1/2 & 1 \\
\end{bmatrix}
$$

このとき，重要度ベクトル $\mathbf{w}$ は以下のようになる．これは，理論から計算した重要度ベクトルと一致する．

$$
w_1 = \frac{(1 \times 3 \times 6)^{1/3}}{(1 \times 3 \times 6)^{1/3} + (1/3 \times 1 \times 2)^{1/3} + (1/6 \times 1/2 \times 1)^{1/3}}  \approx 0.67
$$

$$
w_2 = \frac{(1/3 \times 1 \times 2)^{1/3}}{(1 \times 3 \times 6)^{1/3} + (1/3 \times 1 \times 2)^{1/3} + (1/6 \times 1/2 \times 1)^{1/3}}  \approx 0.22
$$

$$
w_3 = \frac{(1/6 \times 1/2 \times 1)^{1/3}}{(1 \times 3 \times 6)^{1/3} + (1/3 \times 1 \times 2)^{1/3} + (1/6 \times 1/2 \times 1)^{1/3}}  \approx 0.11
$$

一般に，一対比較行列 $\mathbf{A}$ が整合性を持つならば，幾何平均法で計算した重要度ベクトル $\mathbf{w}$ は理論から計算した重要度ベクトルと一致する．興味があれば，証明してみよう．

### 固有ベクトル法*

:::{.callout-tip}
固有ベクトル法は直感的に理解することが難しいため，講義では扱わない．
:::

一対比較行列 $\mathbf{A}$ が整合性を持つとき，

$$
\mathbf{A} \mathbf{w} = \begin{bmatrix}
w_1/w_1 & w_1/w_2 & \cdots & w_1/w_n \\
w_2/w_1 & w_2/w_2 & \cdots & w_2/w_n \\
\vdots & \vdots & \ddots & \vdots \\
w_n/w_1 & w_n/w_2 & \cdots & w_n/w_n \\
\end{bmatrix}
\begin{bmatrix}
w_1 \\
w_2 \\
\vdots \\
w_n \\
\end{bmatrix}
= \begin{bmatrix}
n w_1 \\
n w_2 \\
\vdots \\
n w_n \\
\end{bmatrix}
= n \mathbf{w}
$$

が成り立つ．式 $\mathbf{A} \mathbf{w} = n \mathbf{w}$ より，$\mathbf{w}$ は $\mathbf{A}$ の固有ベクトル，$n$ は $\mathbf{A}$ の固有値である．

Saatyは，最大固有値 $\lambda_{max}$ に対応する固有ベクトルを重要度ベクトルとして用いることを提案した．すなわち，重要度ベクトル $\mathbf{w}$ を求めるには，以下の式を解く．

$$
\mathbf{A} \mathbf{w} = \lambda_{max} \mathbf{w}
$$

@exm-pairwise の一対比較行列が与えられたとする．

$$
\mathbf{A} = \begin{bmatrix}
1 & 3 & 6 \\
1/3 & 1 & 2 \\
1/6 & 1/2 & 1 \\
\end{bmatrix}
$$

このとき，$\mathbf{A}$ の固有値は，$\det(\mathbf{A} - \lambda \mathbf{I}) = 0$ を解くことで求められる．

\begin{align*}
\det(\mathbf{A} - \lambda \mathbf{I}) &= \det\begin{bmatrix}
1 - \lambda & 3 & 6 \\
1/3 & 1 - \lambda & 2 \\
1/6 & 1/2 & 1 - \lambda \\
\end{bmatrix} \\
&= -\lambda^3 + 3\lambda^2 \\
&= -\lambda^2(\lambda - 3)
\end{align*}

$\lambda^2(\lambda - 3) = 0$ より，$\lambda = 0, 3$ が得られる．この例において，$\mathbf{A}$ の最大固有値は $\lambda_{max} = 3$ であり，それ以外の固有値は $\lambda = 0$ である．また，$\mathbf{A}$ は $3 \times 3$ 行列であるため，$\lambda_{max} = n$ が成り立つ．これは特別な例ではなく，一般に @prp-lambda-n が成り立つ．

:::{#prp-lambda-n}
整合性のある $n \times n$ 行列 $\mathbf{A}$ の最大固有値は $\lambda_{max} = n$ であり，それ以外の固有値は $\lambda = 0$ である．
:::

行列 $\mathbf{A}$ は整合性を持たないとき，$\lambda_{max} > n$ が成り立つ．@prp-Saaty は $\lambda_{max}$ の性質を述べている．

:::{#prp-Saaty}
## Saaty
$\mathbf{A}$ を一対行列とする．$\mathbf{A}$ が整合性を持つならば，$\lambda_{max} = n$ である．$\mathbf{A}$ が整合性を持たないならば，$\lambda_{max} > n$ である．
:::

:::{.callout-note}
## 固有値と固有ベクトル（Eigenvalues and Eigenvectors）
$n \times n$ 行列 $\mathbf{A}$ に対し，ベクトル $\mathbf{x} \neq \mathbf{0}$ とスカラー $\lambda$ が存在して，
$$
\mathbf{A} \mathbf{x} = \lambda \mathbf{x}
$$
が成り立つとき，$\mathbf{x}$ を $\mathbf{A}$ の**固有ベクトル** (eigenvector)，$\lambda$ を $\mathbf{A}$ の**固有値** (eigenvalue) と呼ぶ．

例えば，次のような $\mathbf{A}, \mathbf{x}, \lambda$ を考える．
$$
\mathbf{A} = \begin{bmatrix}
1 & 2 \\
1/2 & 1 \\
\end{bmatrix}, \quad
\mathbf{x} = \begin{bmatrix}
2 \\
1 \\
\end{bmatrix}, \quad
\lambda = 2
$$

このとき，

$$
\begin{bmatrix}
1 & 2 \\
1/2 & 1 \\
\end{bmatrix} 
\begin{bmatrix}
2 \\
1 \\
\end{bmatrix}
= \begin{bmatrix}
4 \\
2 \\
\end{bmatrix}
= 2 \begin{bmatrix}
2 \\
1 \\
\end{bmatrix}
$$

が成り立つため，$\mathbf{x}$ は $\mathbf{A}$ の固有ベクトル，$\lambda$ は $\mathbf{A}$ の固有値である．

$\mathbf{A} \mathbf{x} = \lambda \mathbf{x}$ は単位行列 $\mathbf{I}$ を用いて $(\mathbf{A} - \lambda \mathbf{I}) \mathbf{x} = \mathbf{0}$ と書ける．このとき，$\mathbf{x} \neq \mathbf{0}$ であるため，$\det(\mathbf{A} - \lambda \mathbf{I}) = 0$ が成り立つ．

例えば，次のような行列 $\mathbf{A}$ を考える．
$$
\mathbf{A} = \begin{bmatrix}
1 & 2 \\
1/2 & 1 \\
\end{bmatrix} 
$$

このとき，$\det(\mathbf{A} - \lambda \mathbf{I})$ は以下のようになる．

\begin{align*}
\det(\mathbf{A} - \lambda \mathbf{I}) &= \det\begin{bmatrix}
1 - \lambda & 2 \\
1/2 & 1 - \lambda \\
\end{bmatrix} \\
&= (1 - \lambda)^2 - 1 \\
&= \lambda^2 - 2\lambda \\
&= \lambda(\lambda - 2)
\end{align*}

$\lambda(\lambda - 2) = 0$ より，$\lambda = 0, 2$ が得られる．
:::

### GCI

計算された重要度ベクトル $\mathbf{w}$ が一対比較行列 $\mathbf{A}$ とどれくらい整合しているかを評価する指標として，Aguarón が提案した**平均幾何整合度** (geometric consistency index, GCI) がある．

一対比較値 $a_{ij}$ と重要度ベクトル $\mathbf{w}$ から，以下のように $e_{ij}$ を定義する．

$$
e_{ij} = a_{ij} \frac{w_j}{w_i}
$$

$a_{ij} = w_i/w_j$ を満たすならば，$e_{ij} = 1$ である．

GCIは以下のように定義される．

$$
GCI = \frac{2}{(n-1)(n-2)} \sum_{i=1}^{n-1} \sum_{j=i+1}^{n} \left(\ln e_{ij}\right)^2
$$



## 文献案内

@Brunelli2015-mz はAHPを丁寧に解説した書籍である．

## 用語

| English                               | Japanese     |
| ------------------------------------- | ------------ |
| multi-criteria decision making (MCDM) | 多基準意思決定 |
| Analytic Hierarchy Process (AHP)      | 階層分析法   |
| Consistency index                     | 整合度       |
| pairwise comparison matrix            | 一対比較行列 |
| alternative                           | 代替案       |
| criterion                             | 評価基準     |
| priority vector                       | 重要度ベクトル |