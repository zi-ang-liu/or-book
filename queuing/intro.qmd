---
title: 待ち行列モデルの基礎
format:
  html:
    code-fold: true
jupyter: python3
---

:::{.callout-note}
### 学習目標
- ケンドールの記号を理解する．
- 利用率を理解し，計算できる．
- 滞在時間，待ち時間，系内客数，待ち行列長などの評価指標を理解する．
- リトルの法則を理解し，適用できる．
- $G/G/1$，$G/G/c$ 待ち行列の基本的な関係式を理解する．
:::

**客**（customer）がシステムに**到着**（arrival）し，**待ち行列**（queue）に並び，サービスを受け，最後にシステムを**退出**（departure）する．@fig-typical-queueing-system は，典型的な待ち行列システムを示している．

![A typical queueing system](images/typical-queueing.png){#fig-typical-queueing-system}

待ち行列システムは待ち行列とサーバから構成される．これ以降は，待ち行列システムを単に**システム**と呼ぶことにする．

## 待ち行列モデル

一般に，待ち行列モデルは，次の5つの要素で特徴付けられる．

1. 客の到着過程
2. サービス時間分布
3. サーバ数
4. システム容量
5. サービス規律

## ケンドールの記号

待ち行列モデルは，**ケンドールの記号**（Kendall's notation）により表現する．通常以下の形式で表される．

$$
A/B/X
$$

ここで，$A$ は到着間隔分布の種類，$B$ はサービス時間分布の種類，$X$ はサーバ数を表す．また，システム容量は無限大であり，サービス規律は FCFS であると仮定する．

$A$ と $B$ には以下の記号が用いられる．

|記号|意味|
|----|----|
| $M$ | 指数分布|
| $D$ | 決定論的|
| $G$ | 一般分布|
| $E_k$ | $k$ 次アーラン分布|
| $H_k$ | $k$ 次超指数分布|

例えば，客の到着間隔が指数分布に従い，サービス時間が一定であり，サーバ数が1台である待ち行列モデルは，$M/D/1$ 待ち行列と表される．この $M/D/1$ 待ち行列モデルのシステム容量は無限大であり，サービス規律は FCFS であると仮定されている．

$G/G/1$ と $G/G/c$ 待ち行列は，特定の分布を仮定しない待ち行列モデルであるため，得られた結果は多くの待ち行列モデルに適用できる．さらに，$G/G/c$ 待ち行列から得られた結果は，$c = 1$ とすると，$G/G/1$ 待ち行列に適用できる．

:::{.callout-note}
### なぜ指数分布は $M$ と書くのか
1. アーラン分布 $E_k$ と間違えないようにするため．
2. 指数分布のマルコフ性（Markovian property）と無記憶性（memoryless property）に由来する．
:::

## 利用率

$G/G/c$ 待ち行列モデルを考える．時刻 $t$ までに累積到着客数を $A(t)$ とする．時間区間 $[0,t]$ における単位時間あたりの到着客数の平均は
$$
\bar{A}(t) = \frac{A(t)}{t}
$$
で与えられる．以下の極限
$$
\lambda = \lim_{t \to \infty} \bar{A}(t)
$$
が存在するとき，$\lambda$ を**平均到着率**（average arrival rate）と呼ぶ．平均到着率 $\lambda$ は，長期的に見たときの単位時間あたりの平均到着客数を表す．

$S$ をサービス時間を表す確率変数とする．**平均サービス時間** は $\mathbb{E}[S]$ で表される．
単位時間あたりに一つのサーバが処理できる平均客数は
$$
\mu = \frac{1}{\mathbb{E}[S]}
$$
で計算する．$\mu$ を**平均サービス率**（average service rate）と呼ぶ．

:::{#exm-service-rate}
あるゼミでは，学生6人と教員1人が所属している．教員は，1人の学生に対して平均して10分間指導を行う．このとき，平均サービス率と平均サービス時間を求めよ．

平均サービス時間 $\mathbb{E}[S]$ は10分である．平均サービス率 $\mu$ は次のように計算される．

$$
\mu = \frac{1}{\mathbb{E}[S]} = \frac{1}{10 \text{ 分}} = \frac{1}{10/60 \text{ 時間}} = 6 \text{ 人/時間}
$$
すなわち，教員は1時間あたり平均6人の学生に指導を行うことができる．
:::

システムの**利用率** $\rho$ は，次の式で定義される．

$$
\rho = \frac{\lambda}{c \mu} 
$$

ここで，$c$ はサーバ数を表す．利用率 $\rho$ は，到着率 $\lambda$ がシステムの処理能力 $c \mu$ に対してどの程度であるかを示す指標であり，システムの忙しさを表す．$G/G/1$ 待ち行列の場合，$c = 1$ であり，利用率は $\rho = \lambda / \mu$ となる．

$\rho > 1$ の場合，$\lambda > c \mu$ となり，待ち行列が無限に増加する．$\rho = 1$ の場合，$\lambda = c \mu$ となり，到着率とシステムのサービス能力が等しい．$D/D/1$ 待ち行列のように，客の到着間隔とサービス時間がともに一定である場合を除き，待ち行列は無限に増加する．したがって，システムが安定して運用されるためには，$\rho < 1$ である必要がある．

$\lambda$ と $\mu$ が与えられたとき，$\rho < 1$ という条件を用いて，システムが必要なサーバ数 $c$ の最小値を求めることができる．すなわち，

$$
\rho = \frac{\lambda}{c \mu} < 1
$$

を満たす最小の整数 $c$ を求めればよい．

:::{#exm-service-rate}
あるコールセンターでは，オペレーター10人が勤務している．1件の電話対応に平均して10分かかる．1時間あたり30件の電話がかかってくるとする．

1. 社員一人1時間あたりに対応できる電話の平均件数を求めよ．
2. このコールセンターの利用率を求めよ．
3. 待ち行列が無限に増加しないために必要な最小のオペレーター数を求めよ．

平均サービス時間 $\mathbb{E}[S] = 10 \text{ 分} = 1/6 \text{ 時間}$ である．平均サービス率 $\mu$ は
$$
\mu = \frac{1}{\mathbb{E}[S]} = \frac{1}{1/6} = 6 \text{ 件/時間}
$$
となる．すなわち，社員一人は1時間あたり平均6件の電話に対応できることになる．

平均到着率 $\lambda$ は30件/時間，平均サービス率 $\mu$ は6件/時間，サーバ数 $c$ は10である．利用率 $\rho$ は次のように計算される．

$$
\rho = \frac{30}{10 \times 6} = \frac{30}{60} = 0.5
$$

よって，このコールセンターの利用率は0.5である．

安定した運用のためには，$\rho < 1$ を満たす必要がある．すなわち，

$$
c > \frac{\lambda}{\mu} = 5
$$

したがって，最小でオーペレーター6人が必要である．
:::

## 定常状態

十分時間が経過した後，システムの状態は初期状態の影響を受けなくなる．このとき，システムは**定常状態**（steady state）にあるという．

$N(t)$ を時刻 $t$ における系内客数とする．$\mathbb{P}(N(t) = n)$ を時刻 $t$ における系内客数が $n$ である確率とする．$\rho < 1$ のとき，$n = 0, 1, 2, \ldots$ に対して，

$$
\pi_n = \lim_{t \to \infty} P(N(t) = n) 
$$

が存在し，$\pi_n$ は系内客数が $n$ である確率を表す．もう一つの解釈として，$\pi_n$ は系内客数が $n$ である時間の割合を表すとも言える．$\pi_n$ は時刻 $t$ に依存しないことに注意せよ．

<!-- ここまで -->

## 評価指標

待ち行列理論の代表的な性能評価指標を紹介する．

**滞在時間**は客がシステムに到着してサービスを受け，システムを退出するまでにかかる時間である．**待ち時間**は，客がシステムに到着してからサービスを受けるまでの時間である．滞在時間は待ち時間とサービス時間の和に等しい．

$W^{(k)}$ を客 $k$ の滞在時間，$W_q^{(k)}$ を客 $k$ の待ち時間とする．以下の極限が存在するとき，平均滞在時間 $\mathbb{E}[W]$，平均待ち時間 $\mathbb{E}[W_q]$ は

$$
\mathbb{E}[W] = \lim_{n \to \infty} \frac{1}{n} \sum_{k=1}^n W^{(k)} , \quad \mathbb{E}[W_q] = \lim_{n \to \infty} \frac{1}{n} \sum_{k=1}^n W_q^{(k)}
$$
で定義される．

**系内客数**はシステム内にいる客数である．**待ち行列長**は待ち行列に並ぶ客数である．

客 $k$ の滞在時間を $W^(k)$ とする．$t \to \infty$ とすると，極限が存在するとき，平均到着率 $\lambda$，平均系内客数 $L$，平均滞在時間 $W$ はそれぞれ次の式で定義される．

$$
\lambda = \lim_{t \to \infty} \frac{A(t)}{t} , \quad L = \lim_{T \to \infty} \frac{1}{T} \int_0^T N(t) dt, \quad W = \lim_{k \to \infty} \frac{1}{k} \sum_{i=1}^k W^{(i)}
$$

|  | システム | 待ち行列 |
| -------- | -------- | -------- |
|客数 | 系内客数 | 待ち行列長 |
|時間 | 滞在時間 | 待ち時間 |

## リトルの法則

**リトルの法則**（Little's Law）は，待ち行列理論における基本的な関係式であり，平均系内客数 $L$，平均到着率 $\lambda$，平均滞在時間 $W$ の関係を示すものである．リトルの法則は $L = \lambda W$ と表される．すなわち，平均系内客数 $L$ は，平均到着率 $\lambda$ と平均滞在時間 $W$ の積に等しい．

:::{#exm-university}
### 大学の在籍学生数

ある大学の経営システム系では，毎年80人の新入生が入学し，卒業までに4年間在籍する．このとき，経営システム系に在籍している学生の平均人数を求めよ．

平均到着率 $\lambda$ は80人/年，平均滞在時間 $W$ は4年である．リトルの法則により，平均系内客数 $L$ は次のように求められる．

$$
L = \lambda W = 80 \times 4 = 320 \text{ 人}
$$

よって，経営システム系には320人の学生が在籍していることになる．
:::

:::{#exm-bank}
ある銀行では，1時間に平均20人の客が来店し，各客が銀行に滞在する平均時間は12分である．このとき，この銀行には平均何人の客がいるか．

平均到着率 $\lambda$ は20人/時間，平均滞在時間 $W = 12 \text{ 分} = 12/60 \text{ 時間}$ である．リトルの法則から，平均系内客数 $L$ は

$$
L = \lambda W = 20 \times \frac{12}{60} = 4 \text{ 人}
$$

となる．すなわち，銀行内には平均して4人の客が滞在する．平均滞在時間 $W$ や平均到着率 $\lambda$ が増加すると，平均系内客数 $L$ も増加することがわかる．
:::



<!-- :::{#thm-littles-law}
### リトルの法則
極限 $\lambda$，$W$ が存在するならば，極限 $L$ も存在し，次の関係式が成り立つ． 
$$
L = \lambda W
$$
::: -->

これまでは，システム全体に関するリトルの法則を紹介したが，待ち行列を「システム」として考えた場合にも同様の関係が成り立つ．平均待ち行列長を $L_q$，平均待ち時間を $W_q$，平均到着率を $\lambda$ とすると，

$$
L_q = \lambda W_q
$$

が成り立つ．

## $G/G/1$，$G/G/c$ 待ち行列

$G/G/1$ と $G/G/c$ 待ち行列における一般的な結論を説明する．記号のまとめを以下に示す．

| 記号 | 意味 |
| ---- | ---- |
| $\lambda$ | 平均到着率，単位時間あたりの到着客数の平均|
| $L$ | 平均系内客数 |
| $W$ | 平均滞在時間|
| $L_q$ | 平均待ち行列長 |
| $W_q$ | 平均待ち時間 |
| $S$ | サービス時間を表す確率変数 |
| $\mu$ | 平均サービス率，単位時間あたりに処理できる客数の平均|
| $c$ | サーバ数 | 
| $\rho$ | 利用率|


### $L$，$W$，$L_q$，$W_q$ の関係

客がシステムに到着してから退出するまでの平均滞在時間 $W$ は，平均待ち時間 $W_q$ と平均サービス時間 $E[S]$ の和で表される．すなわち，

$$
W = W_q + E[S] = W_q + \frac{1}{\mu}
$$

である．リトルの法則により，

$$
L = \lambda W = \lambda \left( W_q + \frac{1}{\mu} \right) =\lambda W_q + \frac{\lambda}{\mu} = L_q + \frac{\lambda}{\mu}
$$

が成り立つ．$L = L_q + \lambda / \mu$ が成り立つから，$\lambda/ \mu$ はサービスを受けている客数の平均を表していると言える．また，$\lambda/ \mu = L - L_q$ であるから，稼働中のサーバ数の平均を表しているとも言える．

以上の関係式をまとめると，次のようになる．

\begin{align*}
L & = \lambda W \\
W & = W_q + \frac{1}{\mu} \\
L_q & = \lambda W_q \\
L & = L_q + \frac{\lambda}{\mu}
\end{align*}

これらの関係式は4つの指標 $L$，$W$，$L_q$，$W_q$ のうち，1つがわかれば，他の3つを計算できることを示している．

## 用語集

| 英語                    | 日本語       |
| ----------------------- | ------------ |
| service facility       | サービス施設 |
| server                 | サーバ     |
| number of servers      | サーバ数   |
| interarrival time      | 到着間隔   |
| service time           | サービス時間 |
| arrival rate           | 到着率     |
| service rate           | サービス率 |
| offered load          |    |

## 演習問題

:::{#exr-ice-cream-shop}
### アイスクリーム屋さん
あるアイスクリーム屋さんでは，1名の店員が客の注文を受け付け，アイスクリームを提供している．平均して，1時間に30人の客が来店している．店員は，1時間に60人の客に対応できる．客の平均待ち時間を $5$ 分とする．

1. このアイスクリーム屋さんの利用率を求めよ．
2. 客の平均滞在時間，平均系内客数，平均待ち行列長を求めよ．

:::

:::{#sol-exr-ice-cream-shop}

平均到着率 $\lambda$ は30人/時間，平均サービス率 $\mu$ は60人/時間である．サーバ数 $c = 1$ であるため，利用率は

$$
\rho = \frac{30}{1 \times 60} = 0.5
$$
となる．

平均サービス時間 $E[S] = 1 \text{ 分}$，平均待ち時間 $W_q = 5 \text{ 分}$ であるから，平均滞在時間 $W$ は

$$
W = W_q + E[S] = 5 + 1 = 6 \text{ 分}
$$
となる．リトルの法則により，平均系内客数 $L$ は
$$
L = \lambda W = 30 \times \frac{6}{60} = 3 \text{ 人}
$$
となる．同様に，平均待ち行列長 $L_q$ は
$$
L_q = \lambda W_q = 30 \times \frac{5}{60} = 2.5 \text{ 人}
$$
となる．
:::